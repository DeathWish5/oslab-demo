# Report

2018011365 张鹤潇

### 编程作业

在 ch4 模板代码的基础上，新增 `sys_mmap` 和 `sys_munmap` 两个系统调用。这两个系统调用在检查输入合法性后，调用当前进程 `MemorySet` 的 `insert_framed_area` 和 `remove_framed_area` 函数增删虚地址映射。

为了在模块间传递错误，我将可能引发错误函数的返回值改成了 `Result<(),()>`.

为了前向兼容，我将前三章作业中实现的功能略作修改后移植到本章代码中。其中， `sys_get_time` 需要将用户空间传入的虚地址转换为实地址，较为复杂。

### 问答题

#### 1

![sv39-pte](lab4_pic/sv39-pte.png)

如上图所示，其中 [63:54] 为保留位，[53:10] 是物理页号，最低的 8 位 [7:0] 则是标志位。

标志位的含义如下：

- V(Valid) 表示该页表项是否合法；
- R/W/X 控制索引到这个页表项的虚拟页面是否允许读/写/取指；
- U 控制索引到这个页表项的虚拟页面在 U 特权级的情况下是否可访问；
- G 控制是否该页表项在所有地址空间都有效；
- A(Accessed) 记录自从页表项上的这一位被清零之后，页表项的对应虚拟页面是否被访问过；
- D(Dirty) 则记录自从页表项上的这一位被清零之后，页表项的对应虚拟页表是否被修改过。

#### 2

1. 缺页导致的异常包括：Instruction/Load/Store page fault

2. 缺页时重要寄存器的值：

   mtvec/stvec: 发生缺页时要跳转的地址，即异常处理程序的地址。

   mepc/sepc: 缺页异常发生指令。

   mcause/scause: 异常种类，应为某种缺页异常。

   mtval/stval: 缺页虚地址。

   mscratch/sstratch: 暂时存放一个字大小的数据。

   mstatus/sstatus: 机器的状态信息。

   mie/sie: 中断使能情况。

   mip/sip: 当前待处理中断。

3. Lazy 策略的好处：

   - 提高内存利用率
   - 提高程序启动的效率

4. 只估计结果数量级，忽略三级页表的前两级索引页：
   $$
   \frac{10\ G}{ 4\ K*2^9}4 K = 20\ MB
   $$

5. 在 `MemorySet` 中维护当前程序未使用页 (即 Lazy 页) 虚实地址映射，发生缺页异常时，在这些 Lazy 页中进行查找，并将相应物理页读入内存。

6. 页表项 V = 0.

#### 3

1. 切换页表：修改 `satp` 寄存器，同时清空 TLB，清空内核态的 I Cache.

2. 用页表项的标志位 U 控制，U = 0 表示该页不能被用户态访问。

3. 单页表减少了页表切换的次数，有利于提高性能。

4. 双页表在切换内核态/用户态时需要更换页表；

   单页表只需在任务切换时更换页表。

### 感想

问答题太多了，令人烦躁。